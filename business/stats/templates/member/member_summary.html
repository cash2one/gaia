{% extends "content_base_v2.html" %}
{% load project_filter %}
{% load account_filter %}

{% block content-panel %}
<div class="xui-wepage-membersPage">
    <div class="relative">
        <ul class="breadcrumb">
            <li>您当前所在位置</li>
            <li><a href="/stats/member_summary/">会员分析</a></li>
            <li class="active">会员概况</li>
        </ul>
    </div>
    <div id="stats-date-filter-view" class="xui-filter xui-filterPanel "></div>

    <table class="xui-summary" >
        <tr>
            <td class="xui-i-left"><p class="xui-i-title">基础数据</p></td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="total_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">会员总数</span>
                    <img class="xui-i-img" id="total_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="subscribed_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">关注会员</span>
                    <img class="xui-i-img" id="subscribed_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="new_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">新增会员</span>
                    <img class="xui-i-img" id="new_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="binding_phone_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">手机绑定会员</span>
                    <img class="xui-i-img" id="binding_phone_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="bought_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">下单会员</span>
                    <img class="xui-i-img" id="bought_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="repeat_buying_member_rate">0.00%</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">会员复购率</span>
                    <img class="xui-i-img" id="repeat_buying_member_rate_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
        </tr>
        <tr style="height:10px;"></tr>
        <tr>
            <td class="xui-i-left"><p class="xui-i-title">会员来源</p></td>
             <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="ori_qrcode_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">发起扫码会员</span>
                    <img class="xui-i-img" id="ori_qrcode_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="share_url_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">发起分享链接会员</span>
                    <img class="xui-i-img" id="share_url_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="member_from_qrcode_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">扫码新增会员</span>
                    <img class="xui-i-img" id="member_from_qrcode_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="self_follow_member_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">直接关注</span>
                    <img class="xui-i-img" id="self_follow_member_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="member_from_share_url_count">0</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">分享链接新增会员</span>
                    <img class="xui-i-img" id="member_from_share_url_count_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
            <td>
                <div class="xui-i-wrap">
                    <span class="xui-i-money" id="member_recommend_rate">0.00%</span><br/>
                    <img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/help.png"/>
                    <span class="xui-i-name">会员推荐率</span>
                    <img class="xui-i-img" id="member_recommend_rate_help" src="/static_v2/img/editor/help.png"/>
                </div>
            </td>
        </tr>
    </table>
    
    <div class="hidden">
        <div 
            data-ui-role="member-summary-base-data-advanced-table"
            data-app="stats"
            data-resource="member_summary"
            data-template-id="#member-date-table-view"
            data-enable-paginator="false"
            data-enable-sort="false"
            data-selectable="false"
            data-item-count-per-page="10"
            data-disable-header-select="true"
            data-args='{"start_date":"{{start_date}}", "end_date":"{{end_date}}"}' 
        ></div>
    </div>
    <div class="xui-chart">
    
    <div class="xui-charWrap" style="height:400px;">
        <div class="xui-i-title"> <div class="xui-i-block"></div>  <span class="ml5">会员增长趋势</span></div>
        <div 
            class="xui-ChartBody" 
            id="memberIncreasement" 
            data-ui-role="statsMemberIncreasementEchart" 
            data-app="stats" 
            data-resource="member_increasement" 
            data-wrap-el=".xa-message-tips-wrap"
        ></div>
    </div> 
    <div class="xui-charWrap" style="height:420px;">
        <div class="xui-i-title"> <div class="xui-i-block"></div>  <span class="ml5">分享链接排行TOP10</span></div>
        <div
            data-ui-role="advanced-table"
            data-app="stats"
            data-resource="member_share_url_rank"
            data-template-id="#member-share-url-rank-view"
            data-enable-paginator="false"
            data-enable-sort="false"
            data-selectable="false"
            data-item-count-per-page="10"
            data-disable-header-select="true"
            class="panel-body" 
            data-args='{"start_date":"{{start_date}}", "end_date":"{{end_date}}"}' 
            class="xa-share-url-data"
            style="padding-top:0px;padding-left:0px;padding-right:0px;"
        ></div>
    </div>
    <div class="xui-charWrap" style="height:420px;">
        <div class="xui-i-title"> <div class="xui-i-block"></div>  <span class="ml5">推广扫码排行TOP10</span></div>
        <div
            data-ui-role="advanced-table"
            data-app="stats"
            data-resource="member_qrcode_rank"
            data-template-id="#member-qrcode-rank-view"
            data-enable-paginator="false"
            data-enable-sort="false"
            data-selectable="false"
            data-item-count-per-page="10"
            data-disable-header-select="true"
            class="panel-body" 
            data-args='{"start_date":"{{start_date}}", "end_date":"{{end_date}}"}'
            style="padding-top:0px;padding-left:0px;padding-right:0px;"
        ></div>
    </div>  
    <div class="xui-charWrap" >
        <div class="xui-i-title"> <div class="xui-i-block"></div>  <span class="ml5">详细数据</span></div>
        <div
            data-ui-role="advanced-table"
            data-app="stats"
            data-resource="member_detail_data"
            data-template-id="#member-detail-data-view"
            data-enable-paginator="true"
            data-enable-sort="false"
            data-selectable="false"
            data-item-count-per-page="10"
            data-disable-header-select="true"
            class="panel-body" 
            data-args='{"start_date":"{{start_date}}", "end_date":"{{end_date}}"}'
            style="padding-top:0px;padding-left:0px;padding-right:0px;"
        ></div>
    </div> 
    </div>
    <div class="cb"></div>
    
</div>
{% endblock %}


{% block js %}

{% verbatim %}
<script id="member-date-table-view" type="text/x-jquery-tmpl">
    
</script>
<script id="member-share-url-rank-view" type="text/x-jquery-tmpl">
    <table class="table xb-theadBg xui-gradeTab">
        <thead>
            <tr>
                <th>排行</th>
                <th>昵称</th>
                <th>推荐人数</th>
            </tr>
        </thead>
        <tbody class="xui-tbodyBg">
            {{if items.length}}
                {{each(i, item) items}}
                <tr>
                    <td>
                        ${item.rank}
                    </td>
                    <td>
                        <a href="/member/detail/?id=${item.member_id}" target='_blank'>
                            {{html item.username}}
                        </a>
                    </td>
                    <td>
                        ${item.followers}
                    </td>
                </tr>
                {{/each}}
            {{else}}
                <tr><td colspan="3"><p style="margin-top:125px;"><img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/warning.png"/><span style="color:#999999;font-size:16px;font-weight:bold;padding-left:10px;">没有相应的数据</span></p></td></tr>
            {{/if}}
        </tbody>
    </table>
</script>

<script id="member-qrcode-rank-view" type="text/x-jquery-tmpl">
    <table class="table xb-theadBg xui-gradeTab">
        <thead>
            <tr style="background: #f5faff;">
                <th>排行</th>
                <th>昵称</th>
                <th>推荐人数</th>
            </tr>
        </thead>
        <tbody>
            {{if items.length}}
                {{each(i, item) items}}
                <tr>
                    <td>
                        ${item.rank}
                    </td>
                    <td>
                        <a href="/member/detail/?id=${item.member_id}" target='_blank'>
                            {{html item.username}}
                        </a>
                    </td>
                    <td>
                        ${item.followers}
                    </td>
                </tr>
                {{/each}}
            {{else}}
                <tr><td colspan="3"><p style="margin-top:125px;"><img class="xui-i-img xui-i-hide" src="/static_v2/img/editor/warning.png"/><span style="color:#999999;font-size:16px;font-weight:bold;padding-left:10px;">没有相应的数据</span></p></td></tr>
            {{/if}}
        </tbody>
    </table>
</script>

<script id="member-detail-data-view" type="text/x-jquery-tmpl">
    <table class="table xb-theadBg xui-gradeTab">
        <thead>
            <tr>
                <th>日期</th>
                <th>新增会员</th>
                <th>手机绑定</th>
                <th>发起分享链接</th>
                <th>发起链接新增</th>
                <th>发起扫码</th>
                <th>扫码新增</th>
                <th>下单会员</th>
            </tr>
        </thead>
        <tbody>
            {{if items.length}}
                {{each(i, item) items}}
                <tr>
                    <td>${item.date}</td>
                    <td>${item.new_member_count}</td>
                    <td>${item.binding_phone_member_count}</td>
                    <td>${item.share_url_member_count}</td>
                    <td>${item.member_from_share_url_count}</td>
                    <td>${item.ori_qrcode_member_count}</td>
                    <td>${item.member_from_qrcode_count}</td>
                    <td>${item.bought_member_count}</td>
                </tr>
                {{/each}}
            {{else}}
                <tr><td colspan="8">没有相应的数据</td></tr>
            {{/if}}
        </tbody>
    </table>
</script>
{% endverbatim %}

<script type="text/javascript">
    $(document).ready(function() {
        var view = new W.view.stats.DateFilterView({
            el : '#stats-date-filter-view'
        });
        view.render();

        $('#start_date').val('{{start_date}}');
        $('#end_date').val('{{end_date}}');
        view.updateTimeTags();

        $(document).delegate('.xa-date-search','click',function(event) {
            var args = {};
            args.start_date = $('#start_date').val();
            args.end_date = $('#end_date').val();

            //更新基础数据的数据
            $('[data-ui-role="member-summary-base-data-advanced-table"]').data('view').reload(args);

            //更新其他advanced table数据
            $('[data-ui-role="advanced-table"]').each(function(){
                $(this).data('view').reload(args);
            });

            //更新会员增长趋势数据
            $('[data-ui-role="statsMemberIncreasementEchart"]').data('view').reload(args);

            view.updateTimeTags();
        });

        $('#total_member_count_help').popover({
            content : "<div class='xui-i-alert'>已关注和已取消关注的会员总数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#new_member_count_help').popover({
            content : "<div class='xui-i-alert'>新增关注的会员去重人数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

     
        $('#subscribed_member_count_help').popover({
            content : "<div class='xui-i-alert'>当前关注的会员总数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#binding_phone_member_count_help').popover({
            content : "<div class='xui-i-alert'>新增手机绑定会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#bought_member_count_help').popover({
            content : "<div class='xui-i-alert'>下单的会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#repeat_buying_member_rate_help').popover({
            content : "<div class='xui-i-alert'>时间段内，再次购买人数/总购买人数x100%</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#ori_qrcode_member_count_help').popover({
            content : "<div class='xui-i-alert'>发起推广扫码的会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#share_url_member_count_help').popover({
            content : "<div class='xui-i-alert'>发起分享链接的会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#member_from_qrcode_count_help').popover({
            content : "<div class='xui-i-alert'>通过扫码新关注的会员数（包括推广扫码、带参数二维码）</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        $('#self_follow_member_count_help').popover({
            content : "<div class='xui-i-alert'>直接关注的会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });
        $('#member_from_share_url_count_help').popover({
            content : "<div class='xui-i-alert'>通过分享链接新关注的会员数</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });
        $('#member_recommend_rate_help').popover({
            content : "<div class='xui-i-alert'>时间段内，发起推荐会员数/会员总数x100%</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });
    });
        
    
</script>

{% endblock %}
